###### TEMP FILE IGNORE ######

from flask import Flask, render_template, request #, url_for, request
from werkzeug.utils import secure_filename
import os
import generate_image
import numpy as np
from skimage.io import imsave
import time

import tensorflow as tf

#def build_model():
#    print("here we can build the model and save using pickle.\n so that we need not rebuild everytime while malware detection.")
#    return




EDGE = 350 # edge size that has to align with the model that is being loaded


def malware_detection(filename):
    img = generate_image.generate_2D_image("./static/UploadFiles/"+filename,EDGE)
    test_x = np.array(img)
    imsave('./static/resultImages/test.png', test_x)
    #get the model file   model = tf.keras.models.load_model('saved_model/my_model')
    #return new_model.predict(imag)
    return [0.49,0.51]

app = Flask(__name__)
app.static_folder = 'static'
app.config['SECRET_KEY']='supersecretkey'
app.config['UPLOAD_FOLDER']='./static/UploadFiles'


@app.route('/')
def home():
    return render_template("index.html")

@app.route('/upload')
def upload():
    return render_template("upload.html")


@app.route("/scan", methods=['POST','GET'])
def scan():
    res_predict="unknown"
    if request.method=='POST':
        filein=request.files['fileInput']
        if filein.filename =='':
            print("image must have a filename")
            return render_template("upload.html",msg="No file uploaded")
       

        filename = secure_filename(filein.filename)
        basedir = os.path.abspath(os.path.dirname(__file__))
        filein.save(os.path.join(basedir, app.config["UPLOAD_FOLDER"], filename))
         
        res_p =  malware_detection(filename) 
        print("file is uploaded")
        #if res_p == 1:
        #    res_predict = "Malware Detected in "+filename
        #else :
        #    res_predict= "No Malware Present in "+filename
        #print(res_predict)
        return render_template('result.html', result=res_p)

 
if __name__ == '__main__':
    '''
    import os
    path='./random_forest.joblib'
    if not os.path.exists(path):
        build_model()
    '''
    #build_model()
    app.debug=True
    app.run(host='localhost')
